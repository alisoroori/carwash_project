<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Debug Past Bookings</title>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body>
    <div x-data="{
        bookings: [],
        loading: false,
        error: null,
        async loadHistory() {
            console.log('ğŸ” Starting loadHistory...');
            this.loading = true;
            this.error = null;
            try {
                console.log('ğŸ“¡ Fetching from API...');
                const response = await fetch('/carwash_project/backend/api/get_reservations.php', {
                    method: 'GET',
                    credentials: 'same-origin',
                    headers: { 
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest' 
                    }
                });
                
                console.log('ğŸ“¦ Response status:', response.status);
                console.log('ğŸ“¦ Response ok:', response.ok);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const text = await response.text();
                console.log('ğŸ“„ Raw response (first 500 chars):', text.substring(0, 500));
                
                let data;
                try {
                    data = JSON.parse(text);
                    console.log('âœ… Parsed JSON:', data);
                } catch (e) {
                    console.error('âŒ JSON parse error:', e);
                    throw new Error('Invalid JSON response');
                }
                
                console.log('ğŸ” data.success:', data.success);
                console.log('ğŸ” data.bookings:', data.bookings);
                console.log('ğŸ” data.bookings type:', typeof data.bookings);
                console.log('ğŸ” data.bookings length:', data.bookings ? data.bookings.length : 'N/A');
                
                if (data.success) {
                    this.bookings = data.bookings || [];
                    console.log('âœ… Loaded', this.bookings.length, 'past bookings');
                    console.log('ğŸ“‹ First booking:', this.bookings[0]);
                } else {
                    this.error = data.message || 'Failed to load booking history';
                    console.error('âŒ API error:', data);
                }
            } catch (err) {
                this.error = 'Failed to load booking history: ' + err.message;
                console.error('âŒ History load error:', err);
                console.error('âŒ Stack:', err.stack);
            } finally {
                console.log('ğŸ Setting loading = false');
                this.loading = false;
                console.log('ğŸ Final state - loading:', this.loading, 'bookings:', this.bookings.length, 'error:', this.error);
            }
        }
    }" x-init="loadHistory()">
        
        <h1>Debug Past Bookings</h1>
        
        <div x-show="loading">
            <p>â³ Loading...</p>
        </div>
        
        <div x-show="error" style="color: red;">
            <p>âŒ Error: <span x-text="error"></span></p>
        </div>
        
        <div x-show="!loading && !error && bookings.length === 0">
            <p>ğŸ“­ No bookings found</p>
        </div>
        
        <div x-show="!loading && bookings.length > 0">
            <p>âœ… Found <span x-text="bookings.length"></span> bookings</p>
            <ul>
                <template x-for="booking in bookings" :key="booking.booking_id">
                    <li x-text="'#' + booking.booking_id + ' - ' + booking.service_name"></li>
                </template>
            </ul>
        </div>
        
        <hr>
        <h2>Raw State</h2>
        <pre x-text="JSON.stringify({ loading, error, bookingsCount: bookings.length }, null, 2)"></pre>
    </div>
    
    <script>
        console.log('ğŸš€ Page loaded, Alpine should initialize now...');
    </script>
</body>
</html>
