<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Araç Görünümü — CarWash (Visual)</title>
  <style>
    :root{--bg:#f6f8fb;--card:#fff;--muted:#6b7280;--accent:#667eea}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#f8fafc,#eef2ff);margin:0;color:#111}
    .wrap{max-width:1100px;margin:28px auto;padding:20px}
    header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
    .logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#764ba2);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
    h1{font-size:1.25rem;margin:0}
    .controls{display:flex;gap:8px;margin-top:8px;align-items:center}
    .btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
    .btn.secondary{background:#fff;color:var(--accent);border:1px solid #e6e9f2}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px;margin-top:18px}
    .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(17,24,39,0.06);display:flex;flex-direction:column;width:270px;gap:8px}
  /* larger thumbnail for clearer images, responsive aspect ratio */
  .thumb {
    aspect-ratio: 16 / 10; /* responsive width-to-height ratio */
    min-height: 150px; /* minimum height for small screens */
    max-height: 250px; /* maximum height for large screens */
    border-radius: 8px;
    background: #eef2ff;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    position: relative;
  }
  .thumb img{width:100%;height:100%;object-fit:cover;display:block}
  /* show a subtle overlay when image is loading or missing */
  .thumb::after{content:'';position:absolute;inset:0;background:linear-gradient(180deg,rgba(0,0,0,0.03),rgba(0,0,0,0.06));pointer-events:none;border-radius:8px}
  /* image error badge inside thumbnail */
  .thumb .img-err{position:absolute;left:8px;bottom:8px;background:rgba(255,255,255,0.95);color:#7f1d1d;padding:6px 8px;border-radius:6px;font-size:0.85rem;box-shadow:0 4px 10px rgba(17,24,39,0.06)}
    .meta{display:flex;justify-content:space-between;align-items:center}
    .meta .title{font-weight:600}
    .muted{color:var(--muted);font-size:0.9rem}
    .actions{display:flex;gap:8px;margin-top:8px}
    input[type=text],input[type=number],select,textarea{width:100%;padding:8px;border:1px solid #e6e9f2;border-radius:8px;background:#fff}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .panel{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(17,24,39,0.03);margin-top:18px}
    .small{font-size:0.9rem;color:var(--muted)}
    .info{color:#065f46;background:#ecfdf5;padding:8px;border-radius:8px}
    .err{color:#7f1d1d;background:#fff1f2;padding:8px;border-radius:8px}
    footer{margin-top:20px;color:var(--muted);font-size:0.85rem}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">CW</div>
      <div>
        <h1>Araçlar — Görsel Yönetim</h1>
        <div class="small">Frontend visualization for vehicles (uses <a href="/carwash_project/backend/dashboard/vehicle_api.php">vehicle_api.php</a> and <a href="/carwash_project/backend/dashboard/Customer_Dashboard_process.php">Customer_Dashboard_process.php</a>)</div>
        <div class="controls">
          <button class="btn" id="refreshBtn">Yenile</button>
          <button class="btn secondary" id="newBtn">Yeni Araç Ekle</button>
          <span id="status" class="small"></span>
        </div>
      </div>
    </header>

    <div id="messages"></div>

    <main>
      <div class="grid" id="vehiclesGrid" aria-live="polite"></div>

      <section class="panel" id="formPanel" style="display:none">
        <h3 id="formTitle">Yeni Araç</h3>
        <form id="vehicleForm">
          <input type="hidden" name="action" id="formAction" value="create">
          <input type="hidden" name="vehicle_id" id="formVehicleId" value="">
          <div class="form-row">
            <div><label class="small">Marka</label><input type="text" name="car_brand" id="car_brand" required></div>
            <div><label class="small">Model</label><input type="text" name="car_model" id="car_model"></div>
          </div>
          <div style="margin-top:8px">
            <label class="small">Plaka</label>
            <input type="text" name="license_plate" id="license_plate">
          </div>
          <div class="form-row" style="margin-top:8px">
            <div><label class="small">Yıl</label><input type="number" name="car_year" id="car_year" min="1900" max="2099"></div>
            <div><label class="small">Renk</label><input type="text" name="car_color" id="car_color"></div>
          </div>

          <div style="margin-top:8px">
            <label class="small">Resim (opsiyonel)</label>
            <input type="file" id="vehicle_image" name="vehicle_image" accept="image/*">
          </div>

          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
            <button type="button" class="btn secondary" id="cancelForm">İptal</button>
            <button type="submit" class="btn" id="submitForm">Kaydet</button>
          </div>
        </form>
        <div id="formInfo" class="small" style="margin-top:8px"></div>
      </section>
    </main>

    <footer>
      <div>Visual page: <a href="/carwash_project/frontend/visualizations/vehicles_preview.html">frontend/visualizations/vehicles_preview.html</a></div>
      <div>Backend endpoints: <a href="/carwash_project/backend/dashboard/vehicle_api.php">vehicle_api.php</a>, <a href="/carwash_project/backend/dashboard/Customer_Dashboard_process.php">Customer_Dashboard_process.php</a></div>
    </footer>
  </div>

  <script>
    // Show a small badge and set a fallback when an image fails to load
    function handleImageError(img){
      try{
        // avoid recursive loops
        img.onerror = null;
        img.src = '/carwash_project/frontend/assets/default-car.png';
        // display error badge inside thumbnail
        var thumb = img.closest && img.closest('.thumb');
        if(thumb){
          var badge = thumb.querySelector('.img-err');
          if(!badge){
            badge = document.createElement('div');
            badge.className = 'img-err';
            badge.textContent = 'Görsel yüklenemedi';
            thumb.appendChild(badge);
          }
        }
      }catch(e){
        console && console.error && console.error('handleImageError', e);
      }
    }

    // Resolve vehicle image URL with proper fallbacks
    function resolveVehicleImageUrl(path) {
      if (!path || path.trim() === '') {
        return '/carwash_project/frontend/assets/default-car.png';
      }
      
      // If already relative or HTTP/HTTPS, return as-is
      if (path.startsWith('/') || path.startsWith('http://') || path.startsWith('https://')) {
        return path;
      }
      
      // If absolute Windows path, try to convert to relative
      if (/^[A-Za-z]:/.test(path)) {
        // This shouldn't happen with the database fixes, but handle it just in case
        console.warn('Absolute path detected in resolveVehicleImageUrl:', path);
        return '/carwash_project/frontend/assets/default-car.png';
      }
      
      // Other cases - assume relative
      return path;
    }

    const grid = document.getElementById('vehiclesGrid');
    const status = document.getElementById('status');
    const messages = document.getElementById('messages');
    const formPanel = document.getElementById('formPanel');
    const vehicleForm = document.getElementById('vehicleForm');
    const formTitle = document.getElementById('formTitle');
    const formAction = document.getElementById('formAction');
    const formVehicleId = document.getElementById('formVehicleId');
    const refreshBtn = document.getElementById('refreshBtn');
    const newBtn = document.getElementById('newBtn');
    const cancelForm = document.getElementById('cancelForm');

    // Try to extract CSRF token by fetching Customer_Dashboard (works if you're logged in)
    async function fetchCsrfToken() {
      try {
        const res = await fetch('/carwash_project/backend/dashboard/Customer_Dashboard.php', { credentials: 'same-origin' });
        if (!res.ok) return '';
        const text = await res.text();
        const m = text.match(/name=["']csrf_token["']\s+value=["']([a-f0-9]{64})["']/i);
        if (m) return m[1];
        return '';
      } catch (e) {
        return '';
      }
    }

    async function showMessage(msg, type='info') {
      messages.innerHTML = `<div class="${type==='error'?'err':'info'}">${msg}</div>`;
      setTimeout(()=>{ if (messages.firstChild) messages.removeChild(messages.firstChild); }, 6000);
    }

    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    async function loadVehicles() {
      status.textContent = 'Yükleniyor…';
      grid.innerHTML = '';
      try {
        const res = await fetch('/carwash_project/backend/dashboard/vehicle_api.php', {
          method: 'GET',
          credentials: 'same-origin',
          headers: { 'Accept': 'application/json' }
        });
        const raw = await res.text();
        let json = null;
        try { json = raw ? JSON.parse(raw) : null; } catch(e){ showMessage('Sunucudan geçersiz cevap alındı.', 'error'); status.textContent=''; return; }
        const isSuccess = json && (json.success === true || String(json.status).toLowerCase() === 'success');
        if (!isSuccess) {
          showMessage(json && (json.message || json.error) ? (json.message || json.error) : 'Araçlar yüklenemedi', 'error');
          status.textContent = '';
          return;
        }
        // support different response shapes: top-level vehicles or data.vehicles
        const vehicles = Array.isArray(json.vehicles) ? json.vehicles : (json.data && Array.isArray(json.data.vehicles) ? json.data.vehicles : []);
        if (vehicles.length === 0) {
          grid.innerHTML = '<div class="small">Kayıtlı araç bulunamadı.</div>';
          status.textContent = '';
          return;
        }
        vehicles.forEach(v => {
          const el = document.createElement('div');
          el.className = 'card';
          // Resolve image_path using helper function
          let src = resolveVehicleImageUrl(v && v.image_path);

          el.innerHTML = `
            <div class="thumb"><img loading="lazy" src="${escapeHtml(src)}" alt="${escapeHtml((v.brand||'')+' '+(v.model||''))}" onerror="handleImageError(this)"/></div>
            <div class="meta"><div>
              <div class="title">${escapeHtml((v.brand||'') + ' ' + (v.model||''))}</div>
              <div class="muted">${escapeHtml(v.license_plate||'—')}</div>
            </div><div class="small">${escapeHtml(v.created_at||'')}</div></div>
            <div class="small">${escapeHtml(v.color||'')} ${v.year? '• ' + escapeHtml(v.year) : ''}</div>
            <div class="actions">
              <button class="btn secondary" data-action="edit" data-id="${v.id}">Düzenle</button>
              <button class="btn" data-action="delete" data-id="${v.id}">Sil</button>
            </div>
          `;
          grid.appendChild(el);
        });
        attachCardHandlers();
        status.textContent = '';
      } catch (e) {
        console.error(e);
        showMessage('Araçlar yüklenirken hata oluştu', 'error');
        status.textContent = '';
      }
    }

    function attachCardHandlers() {
      grid.querySelectorAll('[data-action]').forEach(btn=>{
        btn.addEventListener('click', async (ev)=>{
          const id = btn.dataset.id;
          const action = btn.dataset.action;
          if (action === 'edit') {
            // Fetch detail (from list we have minimal data; fetch all vehicles and pick)
            try {
              const res = await fetch('/carwash_project/backend/dashboard/vehicle_api.php', { method:'GET', credentials:'same-origin', headers:{'Accept':'application/json'} });
              const raw = await res.text();
              const json = raw ? JSON.parse(raw) : null;
              const list = Array.isArray(json.vehicles) ? json.vehicles : (json.data && Array.isArray(json.data.vehicles) ? json.data.vehicles : []);
              const v = (list && Array.isArray(list)) ? list.find(x=>String(x.id)===String(id)) : null;
              if (!v) { showMessage('Araç bulunamadı', 'error'); return; }
              openFormForEdit(v);
            } catch (e) { showMessage('Düzenleme yüklenemedi', 'error'); }
          } else if (action === 'delete') {
            if (!confirm('Bu aracı silmek istediğinize emin misiniz?')) return;
            const csrf = await fetchCsrfToken();
            const fd = new FormData();
            fd.append('action', 'delete');
            fd.append('id', id);
            if (csrf) fd.append('csrf_token', csrf);
            try {
              const res = await fetch('/carwash_project/backend/dashboard/vehicle_api.php', { method:'POST', credentials:'same-origin', body: fd });
              const raw = await res.text();
              const json = raw ? JSON.parse(raw) : null;
              const ok = json && (json.success === true || String(json.status).toLowerCase() === 'success');
              if (ok) {
                showMessage('Araç silindi');
                loadVehicles();
              } else {
                showMessage(json && (json.message||json.error) ? (json.message||json.error) : 'Silme başarısız', 'error');
              }
            } catch (e) { showMessage('Silme isteği başarısız', 'error'); }
          }
        });
      });
    }

    function openFormForCreate(){
      formTitle.textContent = 'Yeni Araç Ekle';
      formAction.value = 'create';
      formVehicleId.value = '';
      vehicleForm.reset();
      formPanel.style.display = 'block';
      window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});
    }

    function openFormForEdit(v){
      formTitle.textContent = 'Araç Düzenle';
      formAction.value = 'update';
      formVehicleId.value = v.id || '';
      document.getElementById('car_brand').value = v.brand || '';
      document.getElementById('car_model').value = v.model || '';
      document.getElementById('license_plate').value = v.license_plate || '';
      document.getElementById('car_year').value = v.year || '';
      document.getElementById('car_color').value = v.color || '';
      formPanel.style.display = 'block';
      window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});
    }

    vehicleForm.addEventListener('submit', async (ev)=>{
      ev.preventDefault();
  const action = formAction.value;
  const fd = new FormData(vehicleForm);
  fd.set('action', action === 'create' ? 'create' : 'update');
      // Ensure backend expects id under 'id' (vehicle_api.php looks for 'id')
      const vid = document.getElementById('formVehicleId').value;
      if (action !== 'create' && vid) {
        // keep existing vehicle_id field but also set 'id' for backend compatibility
        fd.set('id', vid);
      }
      const csrf = await fetchCsrfToken();
      if (csrf) fd.append('csrf_token', csrf);
      try {
        const res = await fetch('/carwash_project/backend/dashboard/vehicle_api.php', { method:'POST', credentials:'same-origin', body: fd });
        const raw = await res.text();
        let json = null;
        try { json = raw ? JSON.parse(raw) : null; } catch(e){ showMessage('Sunucudan beklenmeyen cevap alındı', 'error'); return; }
        const ok = json && (json.success === true || String(json.status).toLowerCase() === 'success');
        if (ok) {
          showMessage('İşlem başarılı');

          // If server returned an id for the created vehicle, populate it so the form becomes editable
          const createdId = (json && json.data && (json.data.vehicle_id || json.data.id)) || json.vehicle_id || json.id || null;
          if (createdId) {
            formVehicleId.value = createdId;
            formAction.value = 'update';
          }

          formPanel.style.display = 'none';
          loadVehicles();
        } else {
          showMessage(json && (json.message||json.error) ? (json.message||json.error) : 'İşlem başarısız', 'error');
        }
      } catch (e) {
        console.error(e);
        showMessage('İstek başarısız', 'error');
      }
    });

    cancelForm.addEventListener('click', ()=>{ formPanel.style.display='none'; });

    refreshBtn.addEventListener('click', ()=>loadVehicles());
    newBtn.addEventListener('click', ()=>openFormForCreate());

    // Initial load
    loadVehicles();
  </script>
</body>
</html>